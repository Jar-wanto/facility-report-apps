<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .header h1 {
      font-size: 2em;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .btn-primary {
      background: white;
      color: #667eea;
    }
    
    .filters {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .filters h3 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
      font-size: 0.9em;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .stat-label {
      color: #777;
      font-size: 1em;
    }
    
    .stat-card.pending .stat-number { color: #ff9800; }
    .stat-card.progress .stat-number { color: #2196f3; }
    .stat-card.resolved .stat-number { color: #4caf50; }
    .stat-card.total .stat-number { color: #667eea; }
    
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    
    .report-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .report-photos {
      height: 200px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .report-photos img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .report-photos .no-photo {
      font-size: 4em;
      opacity: 0.3;
    }
    
    .report-content {
      padding: 20px;
    }
    
    .report-header {
      margin-bottom: 15px;
    }
    
    .report-facility {
      font-size: 1.3em;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }
    
    .report-location {
      color: #777;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .report-problem {
      color: #555;
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .report-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
      font-size: 0.9em;
      color: #777;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.85em;
      display: inline-block;
    }
    
    .status-badge.pending {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .status-badge.progress {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status-badge.resolved {
      background: #e8f5e9;
      color: #388e3c;
    }
    
    .report-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    
    .report-actions select {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
    }
    
    .report-actions button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .report-actions button:hover {
      background: #5568d3;
    }
    
    .loading {
      text-align: center;
      padding: 60px;
      font-size: 1.2em;
      color: #667eea;
    }
    
    .no-reports {
      text-align: center;
      padding: 60px;
      color: #999;
    }
    
    .no-reports-icon {
      font-size: 5em;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-content img {
      max-width: 100%;
      border-radius: 10px;
    }
    
    .close-modal {
      float: right;
      font-size: 2em;
      cursor: pointer;
      color: #999;
      line-height: 0.8;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .reports-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>üîê Admin Dashboard</h1>
        <p>Manage facility problem reports</p>
      </div>
      <div class="header-actions">
        <!-- <button class="btn btn-secondary" onclick="testConnection()">üîå Test</button>
        <button class="btn btn-secondary" onclick="debugGetReports()">üêõ Debug</button> -->
        <button class="btn btn-secondary" onclick="loadReports()">üîÑ Refresh</button>
        <a href="<?= ScriptApp.getService().getUrl() ?>" class="btn btn-primary">‚Üê Home</a>
      </div>
    </div>
    
    <div class="stats" id="stats">
      <div class="stat-card total">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">Total Reports</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-number" id="pendingCount">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card progress">
        <div class="stat-number" id="progressCount">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat-card resolved">
        <div class="stat-number" id="resolvedCount">0</div>
        <div class="stat-label">Resolved</div>
      </div>
    </div>
    
    <div class="filters">
      <h3>üîç Filter Reports</h3>
      <div class="filter-grid">
        <div class="filter-group">
          <label>Status</label>
          <select id="statusFilter" onchange="applyFilters()">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Facility Name</label>
          <input type="text" id="facilityFilter" placeholder="Search facility..." oninput="applyFilters()">
        </div>
        <div class="filter-group">
          <label>Start Date</label>
          <input type="date" id="startDateFilter" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label>End Date</label>
          <input type="date" id="endDateFilter" onchange="applyFilters()">
        </div>
      </div>
      <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
    </div>
    
    <div class="loading" id="loading">
      ‚è≥ Loading reports...
    </div>
    
    <div class="reports-grid" id="reportsGrid"></div>
    
    <div class="no-reports" id="noReports" style="display: none;">
      <div class="no-reports-icon">üìã</div>
      <h3>No Reports Found</h3>
      <p>There are no reports matching your filters.</p>
    </div>
  </div>
  
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">√ó</span>
      <div id="modalContent"></div>
    </div>
  </div>
  
  <script>
    let allReports = [];
    
    window.onload = function() {
      console.log('Page loaded, starting to load reports...');
      console.log('Google object available?', typeof google !== 'undefined');
      console.log('Google.script available?', typeof google !== 'undefined' && typeof google.script !== 'undefined');
      
      // Check if we're in the right environment
      if (typeof google === 'undefined' || typeof google.script === 'undefined') {
        console.error('ERROR: Google Apps Script client library not loaded!');
        alert('ERROR: This page must be accessed through the Apps Script Web App URL, not the embedded content URL.\n\nPlease use the deployment URL that looks like:\nhttps://script.google.com/macros/s/YOUR_SCRIPT_ID/exec');
        return;
      }
      
      loadReports();
    };
    
    function testConnection() {
      console.log('Testing connection...');
      
      if (typeof google === 'undefined' || typeof google.script === 'undefined') {
        alert('Google Apps Script is not available. Make sure you\'re accessing the page through the correct deployment URL.');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Test connection result:', result);
          alert('‚úÖ Connection successful!\n\n' + JSON.stringify(result, null, 2));
        })
        .withFailureHandler(function(error) {
          console.error('Test connection failed:', error);
          alert('‚ùå Connection failed:\n' + error.message);
        })
        .testConnection();
    }
    
    function debugGetReports() {
      console.log('DEBUG: Calling getAllReports directly...');
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('DEBUG getAllReports result:', result);
          console.log('Result type:', typeof result);
          console.log('Result is null?', result === null);
          console.log('Result stringified:', JSON.stringify(result, null, 2));
          
          if (result === null) {
            alert('‚ö†Ô∏è Function returned NULL\n\nTrying simple version...');
            // Try the simple version
            google.script.run
              .withSuccessHandler(function(simpleResult) {
                console.log('Simple version result:', simpleResult);
                alert('Simple version result:\n\n' + JSON.stringify(simpleResult, null, 2));
                
                if (simpleResult && simpleResult.success) {
                  // Use the simple version result
                  allReports = simpleResult.reports;
                  updateStats();
                  displayReports(allReports);
                }
              })
              .withFailureHandler(function(error) {
                alert('Simple version also failed:\n' + error.message);
              })
              .getAllReportsSimple();
          } else {
            alert('‚úÖ getAllReports Result:\n\n' + JSON.stringify(result, null, 2));
          }
        })
        .withFailureHandler(function(error) {
          console.error('DEBUG getAllReports error:', error);
          alert('‚ùå Error:\n' + error.message + '\n\nStack:\n' + error.stack);
        })
        .getAllReports({});
    }
    
    function loadReports() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('reportsGrid').innerHTML = '';
      document.getElementById('noReports').style.display = 'none';
      
      console.log('Calling getAllReports...');
      
      // Important: Pass an empty object, not undefined
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Raw result received:', result);
          console.log('Result type:', typeof result);
          console.log('Result is null?', result === null);
          
          // If null, try the simple version
          if (result === null || result === undefined) {
            console.warn('getAllReports returned null, trying simple version...');
            
            google.script.run
              .withSuccessHandler(function(simpleResult) {
                console.log('Simple version result:', simpleResult);
                document.getElementById('loading').style.display = 'none';
                
                if (simpleResult && simpleResult.success && simpleResult.reports) {
                  allReports = simpleResult.reports;
                  updateStats();
                  displayReports(allReports);
                  
                  if (simpleResult.reports.length === 0) {
                    document.getElementById('noReports').innerHTML = `
                      <div class="no-reports-icon">üìã</div>
                      <h3>No Reports Yet</h3>
                      <p>Reports will appear here once they are submitted.</p>
                    `;
                    document.getElementById('noReports').style.display = 'block';
                  }
                } else {
                  alert('Error: Could not load reports. Result: ' + JSON.stringify(simpleResult));
                  document.getElementById('noReports').style.display = 'block';
                }
              })
              .withFailureHandler(function(error) {
                console.error('Simple version failed:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Failed to load reports (both versions): ' + error.message);
                document.getElementById('noReports').style.display = 'block';
              })
              .getAllReportsSimple();
            
            return;
          }
          
          document.getElementById('loading').style.display = 'none';
          
          console.log('Result success:', result.success);
          
          if (result.success) {
            console.log('Reports array:', result.reports);
            console.log('Number of reports:', result.reports ? result.reports.length : 'undefined');
            
            if (result.reports && Array.isArray(result.reports)) {
              allReports = result.reports;
              console.log('All reports stored:', allReports.length);
              updateStats();
              displayReports(allReports);
              
              if (result.reports.length === 0) {
                document.getElementById('noReports').innerHTML = `
                  <div class="no-reports-icon">üìã</div>
                  <h3>No Reports Yet</h3>
                  <p>Reports will appear here once they are submitted.</p>
                `;
                document.getElementById('noReports').style.display = 'block';
              }
            } else {
              console.error('Reports is not an array:', result.reports);
              alert('Error: Received invalid data format. Reports is not an array.');
              document.getElementById('noReports').style.display = 'block';
            }
          } else {
            console.error('Error from server:', result.message);
            alert('Error loading reports: ' + (result.message || 'Unknown error'));
            document.getElementById('noReports').innerHTML = `
              <div class="no-reports-icon">‚ö†Ô∏è</div>
              <h3>Error Loading Reports</h3>
              <p>${result.message || 'Unknown error'}</p>
              <p style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="loadReports()">Try Again</button>
              </p>
            `;
            document.getElementById('noReports').style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          console.error('AJAX Failed:', error);
          console.log('Error message:', error.message);
          console.log('Error stack:', error.stack);
          
          document.getElementById('loading').style.display = 'none';
          alert('Failed to load reports: ' + error.message);
          document.getElementById('noReports').innerHTML = `
            <div class="no-reports-icon">‚ùå</div>
            <h3>Failed to Load Reports</h3>
            <p>${error.message}</p>
            <p style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="loadReports()">Try Again</button>
            </p>
          `;
          document.getElementById('noReports').style.display = 'block';
        })
        .getAllReports({});
    }
    
    function updateStats() {
      console.log('Updating stats with', allReports.length, 'reports');
      const total = allReports.length;
      const pending = allReports.filter(r => r.status === 'Pending').length;
      const progress = allReports.filter(r => r.status === 'In Progress').length;
      const resolved = allReports.filter(r => r.status === 'Resolved').length;
      
      console.log('Stats - Total:', total, 'Pending:', pending, 'Progress:', progress, 'Resolved:', resolved);
      
      document.getElementById('totalCount').textContent = total;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('progressCount').textContent = progress;
      document.getElementById('resolvedCount').textContent = resolved;
    }
    
    function displayReports(reports) {
      console.log('Displaying', reports.length, 'reports');
      const grid = document.getElementById('reportsGrid');
      grid.innerHTML = '';
      
      if (!reports || reports.length === 0) {
        console.log('No reports to display');
        document.getElementById('noReports').style.display = 'block';
        return;
      }
      
      document.getElementById('noReports').style.display = 'none';
      
      reports.forEach((report, index) => {
        console.log('Creating card for report', index, ':', report);
        const card = createReportCard(report);
        grid.appendChild(card);
      });
      
      console.log('Finished displaying reports');
    }
    
    function createReportCard(report) {
      const card = document.createElement('div');
      card.className = 'report-card';
      
      const photoUrls = report.photoUrls ? report.photoUrls.split(', ').filter(url => url.trim()) : [];
      let firstPhoto = photoUrls[0] || '';
      
      // Convert Drive URL to thumbnail URL for better embedding
      let imageUrl = '';
      let thumbnailUrl = '';
      
      if (firstPhoto) {
        let fileId = '';
        
        if (firstPhoto.indexOf('/file/d/') !== -1) {
          const matches = firstPhoto.match(/\/file\/d\/([^\/\?]+)/);
          if (matches && matches[1]) {
            fileId = matches[1];
          }
        } else if (firstPhoto.indexOf('id=') !== -1) {
          const matches = firstPhoto.match(/id=([^&]+)/);
          if (matches && matches[1]) {
            fileId = matches[1];
          }
        }
        
        if (fileId) {
          // Use Google Drive thumbnail API - works better in iframes
          thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
          imageUrl = 'https://drive.google.com/uc?export=view&id=' + fileId;
          console.log('Using thumbnail URL:', thumbnailUrl);
        } else {
          thumbnailUrl = firstPhoto;
          imageUrl = firstPhoto;
        }
      }
      
      const statusClass = (report.status || 'Pending').toLowerCase().replace(' ', '');
      
      let timestamp = 'Unknown date';
      try {
        timestamp = new Date(report.timestamp).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        console.error('Error parsing timestamp:', report.timestamp);
      }
      
      card.innerHTML = `
        <div class="report-photos" style="cursor: pointer;" onclick="window.open('${imageUrl}', '_blank')" title="Click to open full image">
          ${thumbnailUrl ? `<img src="${thumbnailUrl}" alt="Report photo" 
            onerror="console.error('Thumbnail failed, trying alternate...', this.src); this.src = '${imageUrl}'; this.onerror = function() { this.parentElement.innerHTML='<div class=\\'no-photo\\'><div style=\\'font-size: 3em; margin-bottom: 10px;\\'>üì∑</div><small>Click to view image</small></div>'; };">` : '<div class="no-photo"><div style="font-size: 3em; margin-bottom: 10px;">üì∑</div><small>No photo</small></div>'}
        </div>
        <div class="report-content">
          <div class="report-header">
            <div class="report-facility">${report.facilityName || 'Unknown Facility'}</div>
            <div class="report-location">üìç ${report.location || 'Unknown Location'}</div>
          </div>
          <div class="report-problem">
            <strong>Problem:</strong> ${report.problem || 'No description'}
          </div>
          <div class="report-problem">
            <strong>Expected:</strong> ${report.expectedCondition || 'No description'}
          </div>
          <div class="report-meta">
            <span>${timestamp}</span>
            <span class="status-badge ${statusClass}">${report.status || 'Pending'}</span>
          </div>
          <div class="report-actions">
            <select id="status-${report.rowIndex}" onchange="updateStatus(${report.rowIndex}); event.stopPropagation();">
              <option value="Pending" ${(report.status === 'Pending' || !report.status) ? 'selected' : ''}>Pending</option>
              <option value="In Progress" ${report.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
              <option value="Resolved" ${report.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
            </select>
            <button onclick="viewDetails(${report.rowIndex}); event.stopPropagation();">View</button>
          </div>
        </div>
      `;
      
      return card;
    }
    
    function updateStatus(rowIndex) {
      const newStatus = document.getElementById(`status-${rowIndex}`).value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            const report = allReports.find(r => r.rowIndex === rowIndex);
            if (report) {
              report.status = newStatus;
              updateStats();
              displayReports(allReports);
            }
          } else {
            alert('Error updating status: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('Failed to update status: ' + error.message);
        })
        .updateReportStatus(rowIndex, newStatus);
    }
    
    function viewDetails(rowIndex) {
      const report = allReports.find(r => r.rowIndex === rowIndex);
      if (!report) return;
      
      const photoUrls = report.photoUrls ? report.photoUrls.split(', ').filter(url => url.trim()) : [];
      
      let photosHtml = '';
      photoUrls.forEach(url => {
        let fileId = '';
        
        // Extract file ID
        if (url.indexOf('/file/d/') !== -1) {
          const matches = url.match(/\/file\/d\/([^\/\?]+)/);
          if (matches && matches[1]) {
            fileId = matches[1];
          }
        } else if (url.indexOf('id=') !== -1) {
          const matches = url.match(/id=([^&]+)/);
          if (matches && matches[1]) {
            fileId = matches[1];
          }
        }
        
        if (fileId) {
          const thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
          const fullUrl = 'https://drive.google.com/uc?export=view&id=' + fileId;
          
          photosHtml += `
            <div style="margin: 15px 0; text-align: center;">
              <img src="${thumbnailUrl}" 
                style="max-width: 100%; border-radius: 10px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" 
                onclick="window.open('${fullUrl}', '_blank')"
                onerror="this.src = '${fullUrl}';"
                title="Click to view full size">
              <div style="margin-top: 8px;">
                <a href="${fullUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.9em;">
                  üìé Open in new tab
                </a>
              </div>
            </div>
          `;
        }
      });
      
      const timestamp = new Date(report.timestamp).toLocaleString();
      
      document.getElementById('modalContent').innerHTML = `
        <h2>${report.facilityName}</h2>
        <p><strong>Location:</strong> ${report.location}</p>
        <p><strong>Facility ID:</strong> ${report.facilityId}</p>
        <p><strong>Submitted:</strong> ${timestamp}</p>
        <p><strong>Status:</strong> <span class="status-badge ${(report.status || 'Pending').toLowerCase().replace(' ', '')}">${report.status || 'Pending'}</span></p>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
        <h3>Problem Description</h3>
        <p>${report.problem}</p>
        <h3 style="margin-top: 20px;">Expected Condition</h3>
        <p>${report.expectedCondition}</p>
        ${photosHtml ? '<h3 style="margin-top: 20px;">Photos</h3>' + photosHtml : '<p style="margin-top: 20px; color: #999;">No photos attached</p>'}
      `;
      
      document.getElementById('detailModal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }
    
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const facilityFilter = document.getElementById('facilityFilter').value.toLowerCase();
      const startDate = document.getElementById('startDateFilter').value;
      const endDate = document.getElementById('endDateFilter').value;
      
      let filtered = allReports.filter(report => {
        if (statusFilter && report.status !== statusFilter) return false;
        if (facilityFilter && !report.facilityName.toLowerCase().includes(facilityFilter)) return false;
        if (startDate && new Date(report.timestamp) < new Date(startDate)) return false;
        if (endDate && new Date(report.timestamp) > new Date(endDate + 'T23:59:59')) return false;
        return true;
      });
      
      displayReports(filtered);
    }
    
    function clearFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('facilityFilter').value = '';
      document.getElementById('startDateFilter').value = '';
      document.getElementById('endDateFilter').value = '';
      displayReports(allReports);
    }
  </script>
</body>
</html>